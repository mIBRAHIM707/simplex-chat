name: Build Android APK with Read Receipts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Nix
      uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          sandbox = true
          max-jobs = auto
          
    - name: Cache Nix store
      uses: cachix/cachix-action@v14
      with:
        name: simplex-chat
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: true  # Only use cache, don't push
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses
      
    - name: Install additional dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl git zip unzip zipalign
        
    - name: Validate Kotlin syntax (Read Receipts)
      run: |
        echo "üîç Validating Read Receipts implementation..."
        
        # Check if our files exist and have the right content
        echo "‚úÖ Checking ChatModel.kt..."
        grep -q "sendReadRcptsContacts" apps/multiplatform/common/src/commonMain/kotlin/chat/simplex/common/model/ChatModel.kt || exit 1
        
        echo "‚úÖ Checking SimpleXAPI.kt..."
        grep -q "UserReadReceiptSettings" apps/multiplatform/common/src/commonMain/kotlin/chat/simplex/common/model/SimpleXAPI.kt || exit 1
        
        echo "‚úÖ Checking PrivacySettings.kt..."
        grep -q "setSendReadReceiptsContacts" apps/multiplatform/common/src/commonMain/kotlin/chat/simplex/common/views/usersettings/PrivacySettings.kt || exit 1
        
        echo "‚úÖ All read receipts files validated!"
        
    - name: Build Android APK using official script
      run: |
        echo "üöÄ Building Android APK with Nix + Gradle..."
        chmod +x scripts/android/build-android.sh
        
        # Use the official build script with -s flag (use current source)
        # This will build native libs with Nix and then use Gradle for APK
        ./scripts/android/build-android.sh -s
        
        echo "‚úÖ Build completed successfully!"
        
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: simplex-chat-release-apks
        path: simplex-chat-*.apk
        retention-days: 7
        
    - name: List generated APKs
      run: |
        echo "üì± Generated APK files:"
        ls -la simplex-chat-*.apk
        echo "‚úÖ APKs ready for download!"
        
    - name: Upload build reports
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-reports
        path: |
          apps/multiplatform/*/build/reports/
          /tmp/simplex-chat*/
        retention-days: 1

