name: Build Android APK with Read Receipts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x apps/multiplatform/gradlew
      
    - name: Validate Kotlin syntax (Read Receipts)
      run: |
        echo "üîç Validating Read Receipts implementation..."
        cd apps/multiplatform
        
        # Check if our files exist and have the right content
        echo "‚úÖ Checking ChatModel.kt..."
        grep -q "sendReadRcptsContacts" common/src/commonMain/kotlin/chat/simplex/common/model/ChatModel.kt || exit 1
        
        echo "‚úÖ Checking SimpleXAPI.kt..."
        grep -q "UserReadReceiptSettings" common/src/commonMain/kotlin/chat/simplex/common/model/SimpleXAPI.kt || exit 1
        
        echo "‚úÖ Checking PrivacySettings.kt..."
        grep -q "setSendReadReceiptsContacts" common/src/commonMain/kotlin/chat/simplex/common/views/usersettings/PrivacySettings.kt || exit 1
        
        echo "‚úÖ All read receipts files validated!"
        
    - name: Build Kotlin Multiplatform Common
      run: |
        cd apps/multiplatform
        ./gradlew :common:build --no-daemon --stacktrace
        
    - name: Build Android Debug APK
      run: |
        cd apps/multiplatform
        ./gradlew :android:assembleDebug --no-daemon --stacktrace
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: simplex-chat-debug-apk
        path: apps/multiplatform/android/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: Upload build reports
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-reports
        path: apps/multiplatform/*/build/reports/
        retention-days: 1

  # Optional: Build with different configurations
  build-variants:
    runs-on: ubuntu-latest
    needs: build-android
    if: success()
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        
    - name: Build APK (${{ matrix.build-type }})
      run: |
        cd apps/multiplatform
        ./gradlew :android:assemble${{ matrix.build-type == 'debug' && 'Debug' || 'Release' }} --no-daemon
        
    - name: Upload APK (${{ matrix.build-type }})
      uses: actions/upload-artifact@v4
      with:
        name: simplex-chat-${{ matrix.build-type }}-apk
        path: apps/multiplatform/android/build/outputs/apk/${{ matrix.build-type }}/*.apk
