name: Build Android APK with Read Receipts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Nix
      uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Cache Nix downloads and profile
      uses: actions/cache@v4
      with:
        path: |
          /home/runner/.cache/nix
          /home/runner/.nix-profile
          /nix/var/nix/profiles/per-user/root
        key: ${{ runner.os }}-nix-${{ hashFiles('flake.lock') }}-${{ github.ref }}
        restore-keys: |
          ${{ runner.os }}-nix-${{ hashFiles('flake.lock') }}-
          ${{ runner.os }}-nix-

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}-${{ hashFiles('**/gradle.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # ‚úÖ Public binary caches only
    - name: Enable Cachix binary cache (nix-community)
      uses: cachix/cachix-action@v14
      with:
        name: nix-community

    - name: Enable Cachix binary cache (iohk)
      uses: cachix/cachix-action@v14
      with:
        name: iohk

    - name: Source Nix profile
      run: |
        set +e
        if [ -f /home/runner/.nix-profile/etc/profile.d/nix.sh ]; then
          . /home/runner/.nix-profile/etc/profile.d/nix.sh
        fi
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix.sh
        fi
        if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        fi
        set -e
        nix --version
        echo "üõ† Nix profile sourced"

    - name: Debug Show active substituters
      run: |
        echo "üîé Active substituters:"
        nix show-config | grep substituters || true

    # üö® New Step: Cache diagnostics
    - name: Cache diagnostics (check if builds are coming from cache)
      run: |
        echo "üîç Checking if GHC/alex/happy are fetched or built..."
        nix build .#android --dry-run --json | jq -r '.[] | select(.outputs != null) | [.drvPath, .realisations? // "MISSING (will build)"] | @tsv' || true
        echo "üí° Lines with 'MISSING' mean they will be built instead of fetched from cache."

    - name: Debug Show android closure size
      run: |
        echo "üì¶ Android closure size for .#android:"
        nix path-info -rsSh .#android || true
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        
    - name: Accept Android SDK licenses
      run: yes | sdkmanager --licenses
      
    - name: Install additional dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl git zip unzip zipalign
        
    - name: Build Android APK using official script
      run: |
        echo "üöÄ Building Android APK with Nix + Gradle..."
        chmod +x scripts/android/build-android.sh
        export ARCHES="aarch64 armv7a"
        echo "üìã Environment check:"
        echo "Nix version: $(nix --version)"
        echo "Java version: $(java -version 2>&1 | head -1)"
        echo "Gradle available: $(which gradle || echo 'Using wrapper')"
        if ./scripts/android/build-android.sh -s 2>&1 | tee build.log; then
          echo "‚úÖ Build completed successfully!"
        else
          echo "‚ùå Build failed. Checking logs..."
          tail -100 build.log || true
          find . -name "*.apk" -type f -exec ls -la {} \; || true
          exit 1
        fi
        echo "üì± Checking for generated APK files..."
        ls -la simplex-chat-*.apk || echo "‚ö†Ô∏è  APKs not found in root directory, checking other locations..."
        find . -name "*.apk" -type f | head -10
        
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: simplex-chat-release-apks
        path: |
          simplex-chat-*.apk
          apps/multiplatform/android/build/outputs/apk/release/*.apk
        if-no-files-found: warn
        retention-days: 7
        
    - name: List generated APKs
      run: |
        echo "üì± Generated APK files:"
        if ls simplex-chat-*.apk 1> /dev/null 2>&1; then
          ls -la simplex-chat-*.apk
        else
          echo "‚ö†Ô∏è  No APKs found in root directory"
          find . -name "*.apk" -type f -exec ls -la {} \;
        fi
        
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          build.log
          *.log
        if-no-files-found: ignore
        retention-days: 3
        
    - name: Upload build reports on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-reports
        path: |
          apps/multiplatform/android/build/reports/
          apps/multiplatform/common/build/reports/
          nix-build.log
        if-no-files-found: ignore
        retention-days: 1
